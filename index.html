<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DERMATO — Your AI Skin Health Partner</title>
  <meta name="description" content="DERMATO — AI skin health assistant. Educational guidance and friendly explanations. Not a medical diagnosis." />
  <meta name="theme-color" content="#004d61" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
    /* =========================================================================
       DERMATO — Single-file site (HTML + CSS + JS)
       Font pairing: Poppins (headings, logo) + Inter (body)
       Palette: teal (#009688), navy (#004d61), light green (#66bb6a / #A5D6A7)
       ========================================================================= */

    :root{
      --teal: #009688;
      --navy: #004d61;
      --light-green: #A5D6A7;
      --green-accent: #66bb6a;
      --bg: #f6fbfb;
      --card: #ffffff;
      --muted: #5f7a7b;
      --text: #073233;
      --glass: rgba(255,255,255,0.9);
      --border: rgba(0,0,0,0.06);
      --radius: 16px;
      --shadow-lg: 0 30px 80px rgba(0,0,0,0.12);
      --shadow-md: 0 12px 30px rgba(0,0,0,0.08);
      --maxw: 1180px;
    }

    /* Reset & base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f7fbfb 0%, #f2f9f8 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.55;
      font-size:16px;
    }
    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}
    .container{width:min(var(--maxw),94%);margin-inline:auto}

    /* NAVBAR */
    .navbar{
      position:sticky; top:0; z-index:60;
      background: linear-gradient(90deg, rgba(0,77,97,0.98), rgba(0,77,97,0.92));
      border-bottom: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }
    .nav-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 0;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:52px;height:52px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;
      background: linear-gradient(160deg,#eafff2 0%, #c8f2d0 60%);
      box-shadow: 0 8px 22px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.6);
      border:1px solid rgba(0,77,97,0.06);
      flex:0 0 auto;
    }
    .wordmark{font-family:Poppins, Inter; color:#023437; letter-spacing:.08em; font-weight:800; text-transform:uppercase}
    .nav-menu{display:flex;gap:12px;align-items:center}
    .nav-menu a{padding:.52rem .9rem;border-radius:999px;color:rgba(255,255,255,0.94);font-weight:600}
    .nav-menu a:hover{background:rgba(255,255,255,0.04)}
    .nav-menu a.active{background:rgba(0,0,0,0.12); outline:2px solid rgba(165,214,167,0.12)}

    .nav-toggle{display:none;background:transparent;border:0}
    .nav-toggle span{display:block;width:22px;height:2px;background:#eafff2;margin:4px 0;border-radius:2px}

    /* HERO */
    .hero{
      position:relative;padding:68px 0 44px;overflow:hidden;
      background:
        radial-gradient(900px 400px at 12% 0%, rgba(165,214,167,0.12), transparent 22%),
        linear-gradient(140deg,var(--teal) 0%, var(--navy) 68%);
      color:#fff;
    }
    .hero-inner{display:grid;grid-template-columns:1.05fr .95fr;gap:28px;align-items:center;min-height:360px}
    .hero-copy{padding:12px 0}
    .headline{font-family:Poppins, Inter; margin:0 0 .45rem; font-weight:800; font-size:clamp(2.1rem, 4.2vw, 3.4rem); line-height:1.02}
    .subtext{color:rgba(255,255,255,0.95);margin:.4rem 0 1.05rem;font-size:1.05rem}
    .cta{display:flex;gap:.9rem;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;gap:.6rem;padding:.92rem 1.05rem;border-radius:12px;border:1px solid rgba(255,255,255,0.06);
      background:linear-gradient(90deg,#eafff2,#c8f2d0); color:#053434; font-weight:700; cursor:pointer;
      box-shadow: var(--shadow-md); transition: transform .18s ease, box-shadow .18s ease;
    }
    .btn:hover{transform:translateY(-3px); box-shadow: var(--shadow-lg)}
    .btn-ghost{background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.08)}
    .hero-card{background:rgba(255,255,255,0.02); border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.03); box-shadow:0 20px 40px rgba(0,0,0,0.12)}
    .hero-decor{position:absolute;right:6%;top:18%;width:340px;height:220px;opacity:.16;filter:blur(6px);background:linear-gradient(120deg, rgba(165,214,167,0.95), rgba(0,150,136,0.95));clip-path:ellipse(55% 65% at 60% 30%);transform:rotate(-12deg);pointer-events:none}

    /* Tagline rotator (smooth) */
    .rotator{display:inline-block;min-height:1.6em;position:relative}
    .rotator span{position:absolute;left:0;top:0;right:0;opacity:0;transform:translateY(8px);transition:opacity .6s ease, transform .6s ease}
    .rotator span.active{opacity:1;transform:translateY(0)}

    /* FEATURES */
    .section{padding:56px 0}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .feature{padding:18px;border-radius:14px;background:var(--card);box-shadow:var(--shadow-md);border:1px solid var(--border)}
    .feature h3{font-family:Poppins;margin:.4rem 0 .6rem}

    /* TOOLS + CHAT */
    .tools-grid{display:grid;grid-template-columns:380px 1fr;gap:18px}
    .tools-panel{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);box-shadow:var(--shadow-md)}
    .uploader{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:100px;height:100px;border-radius:12px;object-fit:cover;border:1px solid rgba(0,0,0,0.06)}
    .meter{height:10px;border-radius:999px;background:#f1fbf2;overflow:hidden}
    .meter>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--light-green),var(--green-accent))}

    /* chips */
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{padding:.45rem .65rem;border-radius:999px;background:#f7fdf7;border:1px solid #e1f5dc;color:var(--text);cursor:pointer;font-weight:600}
    .chip.active{background:linear-gradient(90deg,var(--light-green),#dbf6d6);box-shadow:0 8px 28px rgba(139,195,74,0.12);border-color:transparent}

    /* chat */
    .chat-window{height:420px;overflow:auto;padding:12px;border-radius:12px;background:#fbfffe;border:1px solid #e6f6ef}
    .msg{display:flex;margin:.5rem 0}
    .bubble{padding:.75rem .95rem;border-radius:12px;background:#f5fffb;border:1px solid #e6f6ef;max-width:78%}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{background:linear-gradient(90deg,#eafff2,#c8f2d0);border-color:#cfeadb}

    /* PREVIEW SECTION (fixes: no white box, no overlap) */
    .scan-visual {
      border-radius:14px;
      padding:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.96));
      border: 1px solid #e6f6ef;
      box-shadow: 0 22px 48px rgba(0,0,0,0.06);
      min-height:220px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
    }
    .scan-placeholder{
      width:100%;
      max-width:520px;
      height:280px;
      border-radius:12px;
      background:linear-gradient(135deg,#fff,#f7fef7);
      display:flex;align-items:center;justify-content:center;
      color:var(--muted); font-weight:600; border:1px dashed #eaf7ea;
      box-shadow: inset 0 -6px 24px rgba(0,0,0,0.03);
      text-align:center;padding:12px;font-size:1rem;
    }
    .confidence {
      font-weight:700;color:var(--text);font-size:1.05rem;
      background:linear-gradient(90deg,var(--light-green),var(--green-accent));
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }

    /* SETTINGS and footer */
    .settings{padding:12px;border-radius:12px;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow-md)}
    footer{background:#f7fbfb;padding:20px 0;border-top:1px solid #e6f3f1;color:var(--muted)}
    .footer-inner{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}

    /* small screens */
    @media (max-width:980px){
      .hero-inner{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
      .tools-grid{grid-template-columns:1fr}
      .nav-menu{display:none}
      .nav-toggle{display:block}
    }
    @media (max-width:640px){
      .headline{font-size:1.9rem}
    }

    /* Accessibility focus */
    :focus{outline:none;box-shadow:0 0 0 4px rgba(0,150,136,0.12)}
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="navbar" role="banner" id="top">
    <div class="container nav-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- SVG monogram: D with medical cross -->
          <svg width="34" height="34" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
            <defs>
              <linearGradient id="lg1" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0%" stop-color="#eafff2"/>
                <stop offset="100%" stop-color="#bdf0c8"/>
              </linearGradient>
            </defs>
            <rect width="64" height="64" rx="12" fill="#004d61"/>
            <path d="M18 14h14c10 0 20 8 20 18s-8 18-20 18H18z" fill="url(#lg1)"/>
            <!-- medical cross in D -->
            <rect x="26" y="24" width="12" height="16" rx="2" fill="#004d61"/>
            <rect x="22" y="28" width="20" height="8" rx="2" fill="#004d61"/>
          </svg>
        </div>
        <div>
          <div class="wordmark">DERMATO</div>
          <div style="font-size:.84rem;color:rgba(255,255,255,0.92);margin-top:3px;font-weight:600">Your AI Skin Health Partner</div>
        </div>
      </div>

      <nav class="nav-menu" id="nav-menu" role="navigation" aria-label="Primary navigation">
        <a href="#home" class="active">Home</a>
        <a href="#chatbot">Chatbot</a>
        <a href="#about">About</a>
      </nav>

      <button class="nav-toggle" aria-controls="nav-menu" aria-expanded="false" aria-label="Toggle menu">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <!-- HERO -->
  <main id="home" role="main">
    <section class="hero" aria-label="Hero">
      <div class="container hero-inner">
        <div class="hero-copy">
          <h1 class="headline">DERMATO — Your AI Skin Health Partner</h1>
          <p class="subtext">Confident, friendly skin guidance — fast explanations and clear next steps.</p>

          <div style="margin:.45rem 0">
            <span class="rotator" id="rotator" aria-live="polite">
              <!-- tagline placeholders injected by JS -->
              <span class="active">Smart Skin Care, Backed by AI</span>
            </span>
          </div>

          <div class="cta" style="margin-top:14px">
            <button id="startChatBtn" class="btn">Start Chat</button>
            <button id="openToolsBtn" class="btn btn-ghost">Open Tools</button>
          </div>

          <p style="margin-top:12px;color:rgba(255,255,255,0.9);font-size:.95rem">Scan • Understand • Care — designed to support skin health awareness.</p>
        </div>

        <div class="hero-card" aria-hidden="true">
          <div style="font-weight:700;margin-bottom:.4rem">What you can try</div>
          <ul style="margin:0;padding-left:1.05rem">
            <li>Upload a photo (preview only) and run a scan</li>
            <li>Select symptoms & receive practical suggestions</li>
            <li>Chat freely — get clear, human-like replies</li>
            <li>Open Maps to find local dermatologists</li>
          </ul>
          <div style="margin-top:10px">
            <a class="btn btn-ghost" href="#chatbot">Open Chat & Tools</a>
          </div>
        </div>

        <div class="hero-decor" aria-hidden="true"></div>
      </div>
    </section>

    <!-- FEATURES -->
    <section class="section" aria-label="Features">
      <div class="container grid-3">
        <div class="feature">
          <h3>Simple Upload</h3>
          <p>Preview your image locally. The scan flow is simulated for a smooth demo experience.</p>
        </div>
        <div class="feature">
          <h3>Guided Questions</h3>
          <p>Select symptoms, set duration and severity, and run a scan to receive actionable care tips.</p>
        </div>
        <div class="feature">
          <h3>Clinic Finder</h3>
          <p>Open Google Maps to see dermatologists nearby — we request location only when you ask.</p>
        </div>
      </div>
    </section>

    <!-- CHAT + TOOLS -->
    <section id="chatbot" class="section" aria-label="Chat and tools">
      <div class="container tools-grid">
        <!-- TOOLS -->
        <aside class="tools-panel" aria-label="Tools">
          <h3 style="margin:0 0 8px;font-family:Poppins">Tools</h3>

          <div style="margin-bottom:12px">
            <div class="uploader">
              <input id="file" type="file" accept="image/*" aria-label="Upload skin image">
              <button id="clearImg" class="btn btn-ghost" type="button">Clear</button>
              <div id="imgInfo" style="font-size:.9rem;color:var(--muted)"></div>
            </div>

            <div id="preview" class="preview" hidden style="margin-top:10px">
              <img id="thumb" alt="Image preview">
              <div style="flex:1">
                <div class="meter" aria-hidden="true"><span id="qMeter"></span></div>
                <div style="font-size:.85rem;color:var(--muted);margin-top:6px">Preview quality</div>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700;margin-bottom:6px">Symptoms</div>
            <div class="chips" id="chips">
              <button type="button" class="chip" data-s="redness">Redness</button>
              <button type="button" class="chip" data-s="itching">Itching</button>
              <button type="button" class="chip" data-s="pain">Pain</button>
              <button type="button" class="chip" data-s="dryness">Dryness</button>
              <button type="button" class="chip" data-s="pimples">Pimples</button>
              <button type="button" class="chip" data-s="rash">Rash</button>
              <button type="button" class="chip" data-s="scales">Scales</button>
              <button type="button" class="chip" data-s="oozing">Oozing</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label class="kv"><span class="label">Duration</span>
                <input id="dur" class="input" type="number" min="0" step="1" value="1" aria-label="Duration in days"></label>
              <label class="kv"><span class="label">Severity</span>
                <input id="sev" class="input" type="number" min="1" max="10" value="3" aria-label="Severity 1 to 10"></label>
              <button id="scan" class="btn">Scan Image</button>
              <button id="findClinics" class="btn btn-ghost">Find nearby clinics</button>
            </div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)">

          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="font-weight:700">Settings</div>
            <div class="settings">
              <div style="font-size:.95rem;margin-bottom:8px">Optional: connect to a hosted model for remote responses. Leave blank to use the local assistant.</div>
              <label style="display:block;font-size:.9rem;margin-bottom:6px">API host / model URL</label>
              <input id="apiHost" class="input" placeholder="https://api.example.com/model" />
              <label style="display:block;margin-top:8px;font-size:.9rem">API key</label>
              <input id="apiKey" class="input" placeholder="Paste API key here (stored locally)" />
              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="saveSettings" class="btn btn-ghost">Save</button>
                <button id="resetSettings" class="btn">Reset</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;color:var(--muted);font-size:.95rem">
            <strong>Privacy</strong>: Uploaded image previews are handled locally. Data is only sent if you configure an external API and choose to send.
          </div>
        </aside>

        <!-- CHAT -->
        <section class="tools-panel" aria-label="Assistant">
          <h3 style="margin:0 0 8px;font-family:Poppins">Assistant</h3>

          <div class="chat-window" id="chat" role="log" aria-live="polite">
            <div class="msg bot"><div class="bubble">Hi — I’m Dermato. Ask about skin care, upload a photo, or press <b>Scan Image</b> to get a simulated assessment. I provide educational guidance, not medical diagnosis.</div></div>
          </div>

          <form onsubmit="return false" style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <input id="text" type="text" placeholder="Type your question or context…" class="input" style="flex:1" aria-label="Message input">
            <button id="send" class="btn btn-primary">Send</button>
            <button id="clearChat" class="btn btn-ghost">Clear</button>
            <button id="exportChat" class="btn">Export</button>
          </form>

          <div style="margin-top:10px;color:var(--muted);font-size:.92rem">
            Tip: Try asking about acne routines, sunscreen choices, or when to see a dermatologist.
          </div>
        </section>
      </div>
    </section>

    <!-- PREVIEW / SCAN VISUAL (replaces blank white box) -->
    <section class="section" aria-label="Scan preview">
      <div class="container">
        <div class="scan-visual">
          <div id="scanPlaceholder" class="scan-placeholder" role="img" aria-label="Scan placeholder">
            <div>
              <div style="font-size:1.15rem;font-weight:700;color:var(--muted)">Skin Scan Preview</div>
              <div style="margin-top:8px;color:#2f5b57">Placeholder area — your uploaded image will preview here. Press <b>Scan Image</b> for a simulated result.</div>
            </div>
          </div>
          <div class="confidence" id="scanConfidence">Confidence: —%</div>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="section" aria-label="About">
      <div class="container">
        <div class="card" style="padding:18px">
          <h3 style="margin-top:0;font-family:Poppins">About Dermato</h3>
          <p>DERMATO shows how AI-powered skin health guidance can be presented. It focuses on clarity, privacy and practical next steps. It is not a replacement for professional medical diagnosis — seek direct clinical care for urgent or changing conditions.</p>

          <h4 style="margin-top:12px">How it works</h4>
          <ol style="margin:.5rem 0 0 1.1rem;color:var(--muted)">
            <li>Upload an image (previewed locally).</li>
            <li>Select symptoms and provide brief context.</li>
            <li>Run the scan for a simulated assessment & care tips.</li>
            <li>Optionally connect a remote model via Settings for live AI replies.</li>
          </ol>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer aria-label="Footer">
    <div class="container footer-inner">
      <div style="font-weight:700">© <span id="year"></span> DERMATO</div>
      <div style="color:var(--muted);font-size:.92rem;max-width:720px">
        Dermato supports skin health awareness and education. It is <strong>not</strong> a replacement for professional medical advice. If you have pressing concerns, please seek in-person care from a qualified clinician.
      </div>
    </div>
  </footer>

  <!-- ========================= JavaScript ========================= -->
  <script>
    /* =========================================================================
       Client-side JS: interactivity, rotator, upload preview, chat logic,
       simulated scan, settings (local), export/import, accessibility helpers.
       ========================================================================= */

    // Helper selectors
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const now = () => new Date().toISOString();

    // ---------- On load ----------
    document.addEventListener('DOMContentLoaded', () => {
      setupNavToggle();
      setupTaglines();
      setupUploader();
      setupChips();
      setupChat();
      setupScan();
      setupSettings();
      restoreChatHistory();
      setYear();
      // focus first CTA for keyboard users
      setTimeout(()=> { $('#startChatBtn')?.focus(); }, 600);
    });

    // ---------- Nav toggle ----------
    function setupNavToggle(){
      const toggle = $('.nav-toggle'), menu = $('#nav-menu');
      if(!toggle || !menu) return;
      toggle.addEventListener('click', ()=>{
        const open = menu.classList.toggle('open');
        toggle.setAttribute('aria-expanded', String(open));
      });
      // set active on hash change
      window.addEventListener('hashchange', ()=> {
        $$('.nav-menu a').forEach(a => a.classList.toggle('active', a.getAttribute('href') === location.hash));
      });
    }

    // ---------- Taglines ----------
    const taglines = [
      'Smart Skin Care, Backed by AI',
      'From Symptoms to Solutions — Instantly',
      'Your Skin, Our AI Expertise',
      'Find Answers. Feel Better. Faster.',
      'AI-Powered Dermatology, Anytime, Anywhere',
      'Healthy Skin Starts with Dermato',
      'Scan. Detect. Treat.',
      'Your Skin Deserves AI Precision',
      'Instant Dermatology, Zero Waiting Rooms',
      'Confidence in Every Scan',
      'Science Meets Skin Care',
      'Diagnose. Understand. Heal.'
    ];
    function setupTaglines(){
      const host = $('#rotator');
      if(!host) return;
      host.innerHTML = '';
      taglines.forEach((t,i)=> {
        const sp = document.createElement('span');
        sp.textContent = t;
        if(i===0) sp.classList.add('active');
        host.appendChild(sp);
      });
      let idx = 0;
      setInterval(()=> {
        const children = [...host.children];
        children[idx].classList.remove('active');
        idx = (idx + 1) % children.length;
        children[idx].classList.add('active');
      }, 3000);
    }

    // ---------- Uploader & preview ----------
    function setupUploader(){
      const input = $('#file'), thumb = $('#thumb'), preview = $('#preview'), imgInfo = $('#imgInfo'), qMeter = $('#qMeter'), clearBtn = $('#clearImg');
      if(!input) return;
      input.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        imgInfo.textContent = `Selected: ${f.name} • ${humanSize(f.size)}`;
        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = () => {
          // draw a scaled thumbnail to reduce memory size
          const canvas = document.createElement('canvas');
          const maxSide = 420;
          const scale = Math.min(1, maxSide/Math.max(img.width, img.height));
          canvas.width = Math.round(img.width * scale);
          canvas.height = Math.round(img.height * scale);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          if(thumb) thumb.src = canvas.toDataURL('image/jpeg', 0.82);
          if(preview) preview.hidden = false;
          const q = estimateQuality(img.width, img.height);
          if(qMeter) qMeter.style.width = q + '%';
          URL.revokeObjectURL(url);
          // update scan placeholder with preview
          const placeholder = $('#scanPlaceholder');
          if(placeholder){
            placeholder.innerHTML = '<img src="'+thumb.src+'" alt="uploaded preview" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">';
          }
          // log user action
          addMsg('user', `Uploaded image: <code>${f.name}</code> (preview ready)`);
        };
        img.onerror = ()=> {
          imgInfo.textContent = 'Could not load image preview';
        };
        img.src = url;
      });
      clearBtn?.addEventListener('click', ()=>{
        input.value = '';
        if(thumb) thumb.removeAttribute('src');
        if(preview) preview.hidden = true;
        if(imgInfo) imgInfo.textContent = '';
        const placeholder = $('#scanPlaceholder');
        if(placeholder) placeholder.innerHTML = `<div><div style="font-size:1.15rem;font-weight:700;color:var(--muted)">Skin Scan Preview</div><div style="margin-top:8px;color:#2f5b57">Placeholder area — your uploaded image will preview here. Press <b>Scan Image</b> for a simulated result.</div></div>`;
        addMsg('user', 'Cleared uploaded image.');
      });
    }
    function humanSize(bytes){ const units=['B','KB','MB','GB']; let i=0,n=bytes; while(n>=1024 && i<units.length-1){ n/=1024; i++; } return n.toFixed(1)+' '+units[i]; }
    function estimateQuality(w,h){ const pixels = (w||0)*(h||0); const pct = Math.max(12, Math.min(100, Math.round((pixels/(900*900))*100))); return pct; }

    // ---------- Chips (symptoms) ----------
    const selected = new Set();
    function setupChips(){
      $$('.chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          const key = ch.dataset.s;
          if(selected.has(key)){ selected.delete(key); ch.classList.remove('active'); }
          else{ selected.add(key); ch.classList.add('active'); }
        });
      });
    }

    // ---------- Chat (local "smart" fallback) ----------
    const chatNode = $('#chat');
    function addMsg(role, html){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      const b = document.createElement('div'); b.className = 'bubble'; b.innerHTML = html;
      wrap.appendChild(b);
      if(chatNode){ chatNode.appendChild(wrap); chatNode.scrollTop = chatNode.scrollHeight; }
      saveChatHistory();
    }
    function saveChatHistory(){ localStorage.setItem('dermato_chat', chatNode?.innerHTML || ''); }
    function restoreChatHistory(){ const h = localStorage.getItem('dermato_chat'); if(h && chatNode) chatNode.innerHTML = h; }

    function setupChat(){
      const send = $('#send'), text = $('#text'), clear = $('#clearChat'), exportBtn = $('#exportChat');
      send?.addEventListener('click', ()=> { const v = text.value.trim(); if(!v) return; addMsg('user', escapeHtml(v)); text.value=''; simulateReply(v); });
      text?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send?.click(); });
      clear?.addEventListener('click', ()=> { chatNode.innerHTML = '<div class="msg bot"><div class="bubble">Conversation cleared. Ask me anything to begin.</div></div>'; saveChatHistory(); });
      exportBtn?.addEventListener('click', ()=> {
        const data = { exportedAt: now(), html: chatNode.innerHTML };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'dermato-chat.json'; a.click();
        URL.revokeObjectURL(url);
      });
      // quick focus for start chat button
      $('#startChatBtn')?.addEventListener('click', ()=> { $('#text')?.focus(); $('#text')?.scrollIntoView({behavior:'smooth', block:'center'}); });
      $('#openToolsBtn')?.addEventListener('click', ()=> { location.hash = '#chatbot'; setTimeout(()=> $('#text')?.focus(), 400); });
    }

    // Simple heuristic reply function — friendly tone, avoids medical claims
    function simulateReply(userText){
      const thinking = document.createElement('div'); thinking.className='msg bot'; thinking.innerHTML = '<div class="bubble">Thinking…</div>';
      chatNode.appendChild(thinking);
      chatNode.scrollTop = chatNode.scrollHeight;
      setTimeout(()=> {
        thinking.remove();
        const reply = smartLocalReply(userText);
        addMsg('bot', reply);
      }, 700 + Math.random()*700);
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function smartLocalReply(input){
      const txt = (input||'').toLowerCase();
      if(!txt.trim()) return "Could you share more — e.g., symptoms, how long it's lasted, or products you've used?";
      const worried = /\b(worried|scared|anxious|embarrassed|pain|hurts|itch|itching|burn)\b/.test(txt);
      const topicMap = [
        {k:/acne|pimple|zit|blackhead|whitehead/, r:'acne'},
        {k:/eczema|atopic|dermatitis|dry skin|dryness/, r:'eczema'},
        {k:/psoriasis|psoriatic|plaque|scaly/, r:'psoriasis'},
        {k:/fung|ringworm|tinea|yeast/, r:'fungal'},
        {k:/allerg|hive|urticaria|rash|contact/, r:'allergy'},
        {k:/mole|nevus|spot|melanoma|cancer|changing mole/, r:'lesion'},
        {k:/sunscreen|spf|sunburn|uv/, r:'sunscreen'}
      ];
      let matched = null;
      for(const t of topicMap){ if(t.k.test(txt)){ matched = t.r; break; } }

      const open = worried ? "I hear you — that sounds stressful. Let's go step by step." : "Thanks — here's a practical summary:";
      const general = `<ul><li>Use a gentle cleanser; avoid harsh scrubs.</li><li>Apply a fragrance-free moisturizer.</li><li>Use SPF 30+ outdoors.</li><li>Avoid picking at lesions.</li></ul>`;
      let specific = '';
      switch(matched){
        case 'acne': specific = '<strong>Acne tips:</strong> consider benzoyl peroxide 2.5% or salicylic acid 0.5–1% for spot treatment; use non-comedogenic moisturizers.'; break;
        case 'eczema': specific = '<strong>Eczema tips:</strong> moisturize with ceramides, short lukewarm showers, and gentle cleansers. For itch, short-course hydrocortisone may help (follow label).'; break;
        case 'psoriasis': specific = '<strong>Psoriasis:</strong> keratolytics and moisturizers help; discuss topical prescriptions with a clinician.'; break;
        case 'fungal': specific = '<strong>Fungal tips:</strong> keep the area dry; OTC antifungals like clotrimazole can help; avoid sharing towels.'; break;
        case 'allergy': specific = '<strong>Allergic rash:</strong> stop new products, use cool compresses, and consider antihistamines for itch relief.'; break;
        case 'lesion': specific = '<strong>Lesion check:</strong> if a mole is changing in shape, color, or is bleeding, see a clinician promptly.'; break;
        case 'sunscreen': specific = '<strong>Sunscreen:</strong> SPF 30+ broad spectrum; reapply frequently, and choose non-comedogenic if acne-prone.'; break;
        default: specific = '<strong>Context-sensitive suggestion:</strong> share duration and any products used for tailored steps.'; break;
      }
      const close = `<em style="color:#3b4750">If symptoms are severe, spreading, or accompanied by fever, seek a clinician. This assistant is educational and not a medical diagnosis.</em>`;
      return `${open}<br/><br/>${specific}<br/>${general}${close}`;
    }

    // ---------- Scan: simulated flow ----------
    function setupScan(){
      $('#scan')?.addEventListener('click', ()=>{
        const duration = Number($('#dur')?.value||0);
        const severity = Number($('#sev')?.value||3);
        addMsg('user', `Scan requested — symptoms: <code>${[...selected].join(', ') || 'none'}</code>; duration: ${duration}d; severity: ${severity}/10.`);
        const thinking = document.createElement('div'); thinking.className = 'msg bot'; thinking.innerHTML = '<div class="bubble">Analyzing image… <small>▰▱▱▱</small></div>';
        chatNode.appendChild(thinking); chatNode.scrollTop = chatNode.scrollHeight;

        setTimeout(()=> thinking.querySelector('.bubble').innerHTML = 'Analyzing image… <small>▰▰▱▱</small>', 400);
        setTimeout(()=> thinking.querySelector('.bubble').innerHTML = 'Analyzing image… <small>▰▰▰▱</small>', 750);
        setTimeout(()=> thinking.querySelector('.bubble').innerHTML = 'Analyzing image… <small>▰▰▰▰</small>', 1100);

        setTimeout(()=> {
          thinking.remove();
          const cond = pickCondition([...selected]);
          const confidence = Math.max(62, Math.min(97, Math.round(70 + (selected.size*6) + (severity*2) - (duration*0.7))));
          const risk = (severity>=8 || duration>=14) ? 'moderate' : (severity>=5 || duration>=7) ? 'low-to-moderate' : 'low';
          const tips = cond.tips.map(t=>`<li>${t}</li>`).join('');
          const result = `<b>Possible condition:</b> ${cond.cond}<br/><b>Confidence:</b> ~${confidence}% • <b>Risk:</b> ${risk}<br/><b>Suggested care:</b><ul>${tips}</ul><em style="color:#3b4750">If symptoms worsen, see a dermatologist in person.</em>`;
          addMsg('bot', result);
          // update scan visual confidence
          const confNode = $('#scanConfidence'); if(confNode) confNode.textContent = 'Confidence: ~' + confidence + '%';
        }, 1600);
      });
    }

    function pickCondition(sym){
      const s = new Set(sym || []);
      const table = [
        {cond:'Acne Vulgaris', keys:['pimples','redness'], tips:['Use 2.5% benzoyl peroxide','Avoid pore-clogging makeup','Non-comedogenic moisturizer']},
        {cond:'Atopic Dermatitis (Eczema)', keys:['dryness','itching','rash'], tips:['Fragrance-free ceramide moisturizer','Short lukewarm showers','Avoid irritants']},
        {cond:'Seborrheic Dermatitis', keys:['scales','redness','itching'], tips:['Gentle cleanser','Anti-dandruff shampoo for scalp','Moisturize regularly']},
        {cond:'Contact Dermatitis', keys:['rash','itching','redness'], tips:['Stop new product','Cool compresses','Consider antihistamine']},
        {cond:'Folliculitis', keys:['pimples','pain','redness'], tips:['Warm compresses','Avoid shaving','Keep area clean']},
        {cond:'Tinea (Fungal) Infection', keys:['scales','itching','rash'], tips:['Keep area dry','Topical antifungal (clotrimazole)','Avoid sharing towels']},
        {cond:'Psoriasis (Plaque)', keys:['scales','redness'], tips:['Urea/lactic acid moisturizers','Sun protection','Discuss topical therapy with clinician']},
      ];
      let best = table[0], bestScore=-1;
      table.forEach(row=>{
        const score = row.keys.reduce((acc,k)=> acc + (s.has(k)?1:0), 0);
        if(score > bestScore){ best = row; bestScore = score; }
      });
      return best;
    }

    // ---------- Settings ----------
    function setupSettings(){
      const host = $('#apiHost'), key = $('#apiKey'), save = $('#saveSettings'), reset = $('#resetSettings');
      const data = JSON.parse(localStorage.getItem('dermato_settings') || '{}');
      if(data.apiHost) host.value = data.apiHost;
      if(data.apiKey) key.value = data.apiKey;
      save?.addEventListener('click', ()=>{
        const st = { apiHost: host.value.trim(), apiKey: key.value.trim() };
        localStorage.setItem('dermato_settings', JSON.stringify(st));
        addMsg('bot', 'Settings saved locally. Remote model will be used if configured.');
      });
      reset?.addEventListener('click', ()=>{
        localStorage.removeItem('dermato_settings'); host.value=''; key.value='';
        addMsg('bot', 'Settings reset. Using local assistant fallback.');
      });
    }

    // ---------- Utility & misc ----------
    function setYear(){ $('#year') && ($('#year').textContent = new Date().getFullYear()); }
    function restoreChatHistory(){ const h = localStorage.getItem('dermato_chat'); if(h && chatNode) chatNode.innerHTML = h; }
    function nowISO(){ return new Date().toISOString(); }

    // tiny escape helper
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.altKey && e.key.toLowerCase() === 'k'){ e.preventDefault(); $('#text')?.focus(); }
      if(e.altKey && e.key.toLowerCase() === 's'){ e.preventDefault(); $('#scan')?.click(); }
    });
  </script>
</body>
</html>
